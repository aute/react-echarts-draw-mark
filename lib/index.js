import e,{useReducer as t,useEffect as n,useState as r}from"react";import o from"echarts-for-react";import{update as a,last as i,head as s,equals as c,slice as l,remove as h,max as p,curry as y,compose as d}from"ramda";import u from"echarts";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var f=function(){return(f=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function g(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var a=arguments[t],i=0,s=a.length;i<s;i++,o++)r[o]=a[i];return r}var v={grid:{top:0,right:1,bottom:1,left:0},xAxis:{min:0,max:1,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},yAxis:{min:0,max:1,inverse:!0,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},series:[]},m=function(e){var t=e.nativeEvent.offsetX||0,n=e.nativeEvent.offsetY||0;return[t/(e.currentTarget.clientWidth||0)||0,n/(e.currentTarget.clientHeight||0)||0]},E=function(e,t){var n,r;return.05-(n=e,r=t,Math.sqrt(Math.pow(n[0]-r[0],2)+Math.pow(n[1]-r[1],2)))<0?t:e},b=function(e){return c(s(e),i(e))},L=function(e){return a(-1,E(s(e),i(e)),e)},O=function(e){return{anchors:[],color:e.color,over:!1,type:e.shapeType,data:e.data}};function A(e,t){var n=t.type,r=t.location,o=t.newShapeList,i=t.shapeOrdinal,c=t.shapeType,p=t.anchorOrdinal,y=t.color,d=t.data,u=e.shapeList,v=u[e.selected];switch(n){case"CREATE_SHAPE":e={shapeList:g(u,[O({shapeType:c||"line",color:y,data:d})]),selected:u.length};break;case"DELETE_SHAPE":if(void 0===i)break;e={shapeList:h(i,1,u),selected:0};break;case"CHANGE_SELECTED":if(void 0===i)break;e=f(f({},e),{selected:i});break;case"PUSH_ANCHOR":if(!v||v.over||!r)break;if(v.anchors.length<1&&v.anchors.push(r),("polygon"===v.type||"sides_polygon"===v.type)&&v.anchors.length>3&&(v.anchors=L(v.anchors),v.over=b(v.anchors),v.over)){e=f({},e);break}if("sides"===v.type&&v.anchors.length>1){v.over=!0,e=f({},e);break}if("arrow"===v.type&&v.anchors.length>1){v.over=!0,e=f({},e);break}v.anchors.push(r),e=f({},e);break;case"MOVE_LAST_ANCHOR":v&&!v.over&&v.anchors.length>0&&(v.anchors=a(-1,r,v.anchors),e=f({},e));break;case"MOVE_ANCHOR":v&&v.anchors.length>0&&"number"==typeof p&&(v.anchors=a(p,r,v.anchors),"polygon"!==v.type&&"sides_polygon"!==v.type||!v.over||t.anchorOrdinal!==v.anchors.length-1||(v.anchors=a(0,r,v.anchors)),e=f({},e));break;case"OVER":if(v&&!v.over&&v.anchors.length>0){if(v.anchors=l(0,-2,v.anchors),("polygon"===v.type||"sides_polygon"===v.type)&&v.anchors.length>3&&(v.anchors=a(-1,s(v.anchors),v.anchors)),("polygon"===v.type||"sides_polygon"===v.type)&&v.anchors.length<=3)break;if("line"===v.type&&v.anchors.length<2)break;v.over=!0,e=f({},e)}break;case"LOAD":e={selected:!i||i<0||i>=o.length?0:i,shapeList:o}}return e}export default function(a){var i=a.onChange,s=a.onReady,l=a.selected,h=a.showGrid,g=void 0!==h&&h,E=a.value,b=a.lineWidth,L=void 0===b?2:b,O=t(A,{selected:0,shapeList:E}),S=O[0],_=O[1];n((function(){c(S.shapeList,E)||_({type:"LOAD",newShapeList:E})}),[E]),n((function(){_({type:"CHANGE_SELECTED",shapeOrdinal:l})}),[l]),v.xAxis.splitLine.show=g,v.yAxis.splitLine.show=g;var k=r(null),w=k[0],C=k[1];n((function(){if(w){var e=w._dom.clientWidth/w._dom.clientHeight,t=S.shapeList,n=S.selected,r=t[n];w.setOption(f(f({},v),{series:t.map((function(t,r){var o,a,i=t.anchors[0]&&t.anchors[1]?t.anchors:[[0,0],[0,0]],s=i[0],c=s[0],l=s[1],h=i[1],y=h[0],d=h[1];return{type:"line",symbolSize:r===n?12:0,data:t.anchors,lineStyle:{color:t.color,width:L},itemStyle:{color:t.color},markPoint:"arrow"===t.type&&{silent:!0,symbol:"triangle",symbolSize:p(24,2.4*L*2),symbolRotate:y-c>0?180*Math.atan((-d+l)/(y-c)/e)/Math.PI-90:180*Math.atan((d-l)/(-y+c)/e)/Math.PI+90,data:(a=t.anchors[0]?function(e){var t=e[0],n=t[0],r=t[1],o=e[1];return[o[0]-n+n,o[1]-r+r]}(t.anchors):null,a?[{coord:a}]:null),animation:!1},markLine:("sides"===t.type||"sides_polygon"===t.type)&&{silent:!0,symbol:["circle","triangle"],symbolSize:p(24,2.4*L*2),lineStyle:{type:"solid",width:L},data:(o=t.anchors[0]?function(e,t){var n=e[0],r=n[0],o=n[1],a=e[1],i=a[0],s=a[1];return[[(r+i)/2-(o-s)/4/t,(o+s)/2+(r-i)/4*t],[(r+i)/2+(o-s)/4/t,(o+s)/2-(r-i)/4*t]]}(t.anchors,e):null,o?[[{coord:o[0]},{coord:o[1]}]]:null),animation:!1},clip:!1}})),graphic:r?r.anchors.map((function(e,t){return{type:"circle",position:w.convertToPixel("grid",[e[0],e[1]]),shape:{cx:0,cy:0,r:12},invisible:!0,draggable:!0,ondrag:u.util.curry((function(e){var t=w.convertFromPixel("grid",this.position);_({type:"MOVE_ANCHOR",location:[t[0],t[1]],anchorOrdinal:e})}),t),z:100}})):null}),!0),i&&i(S)}}),[S]);var H=function(e){_({type:"CREATE_SHAPE",shapeType:e.shapeType,color:e.color,data:e.data})},T=function(e){_({type:"DELETE_SHAPE",shapeOrdinal:e})};n((function(){w&&(_({type:"LOAD",newShapeList:E,shapeOrdinal:l}),s&&s({createShape:H,deleteShape:T}))}),[w]);var x=y((function(e,t){_({type:e,location:t})}));return e.createElement("div",{style:{height:"100%",width:"100%"},onClick:d(x("PUSH_ANCHOR"),m),onMouseMove:d(x("MOVE_LAST_ANCHOR"),m),onDoubleClick:d(x("OVER"),m),"data-testid":"MarkBoard"},e.createElement(o,{onChartReady:C,option:v,style:{height:"100%",width:"100%"}}))}
