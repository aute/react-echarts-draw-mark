import e,{useEffect as r,useReducer as t,useState as n}from"react";import o from"echarts-for-react";import{equals as a,curry as i,compose as s,slice as c,update as h,head as l,last as p,remove as d}from"ramda";import u from"echarts";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var y=function(){return(y=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function f(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;var n=Array(e),o=0;for(r=0;r<t;r++)for(var a=arguments[r],i=0,s=a.length;i<s;i++,o++)n[o]=a[i];return n}var g={grid:{top:0,right:1,bottom:1,left:0},xAxis:{min:0,max:100,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},yAxis:{min:0,max:100,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},series:[]},v=function(e){var r=e.nativeEvent.offsetX||0,t=e.nativeEvent.offsetY||0;return[100*r/(e.currentTarget.clientWidth||0)||0,100*t/(e.currentTarget.clientHeight||0)||0]},m=function(e,r){var t,n;return 5-(t=e,n=r,Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)))<0?r:e},E=function(e){return a(l(e),p(e))},L=function(e){return h(-1,m(l(e),p(e)),e)},O=function(e){return{anchors:[],color:e.color,over:!1,type:e.shapeType,data:e.data}};function b(e,r){var t=r.type,n=r.location,o=r.newShapeList,a=r.shapeOrdinal,i=r.shapeType,s=r.anchorOrdinal,p=r.color,u=r.data,g=e.shapeList,v=e.selected,m=g[v];switch(t){case"CREATE_SHAPE":e={shapeList:f(g,[O({shapeType:i||"line",color:p,data:u})]),selected:g.length};break;case"DELETE_SHAPE":if(void 0===a)break;e={shapeList:d(a,1,g),selected:0};break;case"CHANGE_SELECTED":if(void 0===a)break;e=y(y({},e),{selected:a});break;case"PUSH_ANCHOR":if(!m||m.over||!n)break;if(m.anchors.length<1&&m.anchors.push(n),"polygon"===m.type&&m.anchors.length>3&&(m.anchors=L(m.anchors),m.over=E(m.anchors),m.over)){e=y({},e);break}if("sides"===m.type&&m.anchors.length>1){m.over=!0,e=y({},e);break}m.anchors.push(n),e=y({},e);break;case"MOVE_LAST_ANCHOR":m&&!m.over&&m.anchors.length>0&&(m.anchors=h(-1,n,m.anchors),e=y({},e));break;case"MOVE_ANCHOR":m&&m.anchors.length>0&&"number"==typeof s&&(m.anchors=h(s,n,m.anchors),"polygon"===m.type&&m.over&&r.anchorOrdinal===m.anchors.length-1&&(m.anchors=h(0,n,m.anchors)),e=y({},e));break;case"OVER":if(m&&!m.over&&m.anchors.length>0){if(m.anchors=c(0,-2,m.anchors),"polygon"===m.type&&m.anchors.length>3&&(m.anchors=h(-1,l(m.anchors),m.anchors)),"polygon"===m.type&&m.anchors.length<=3)break;if("line"===m.type&&m.anchors.length<2)break;m.over=!0,e=y({},e)}break;case"LOAD":v=a,(!a||a<0||a>=o.length)&&(v=0),e={selected:v,shapeList:o}}return e}export default function(c){var h=c.onChange,l=c.onReady,p=c.selected,d=c.showGrid,f=void 0!==d&&d,m=c.value;r((function(){a(L.shapeList,m)||O({type:"LOAD",newShapeList:m})}),[m]),r((function(){O({type:"CHANGE_SELECTED",shapeOrdinal:p})}),[p]),g.xAxis.splitLine.show=f,g.yAxis.splitLine.show=f;var E=t(b,{selected:0,shapeList:m}),L=E[0],O=E[1];r((function(){_&&_.setOption(y(y({},g),{series:L.shapeList.map((function(e,r){return{type:"line",symbolSize:r===L.selected?14:0,data:e.anchors.map((function(e){return[e[0],100-e[1]]})),lineStyle:{color:e.color},itemStyle:{color:e.color},markLine:"sides"===e.type&&{symbol:["circle","triangle"],data:e.anchors[0]&&[[{coord:[(e.anchors[0][0]+e.anchors[1][0])/2-(e.anchors[0][1]-e.anchors[1][1])/4*(_._dom.clientHeight/_._dom.clientWidth),100-((e.anchors[0][1]+e.anchors[1][1])/2+(e.anchors[0][0]-e.anchors[1][0])/4*(_._dom.clientWidth/_._dom.clientHeight))]},{coord:[(e.anchors[0][0]+e.anchors[1][0])/2+(e.anchors[0][1]-e.anchors[1][1])/4*(_._dom.clientHeight/_._dom.clientWidth),100-((e.anchors[0][1]+e.anchors[1][1])/2-(e.anchors[0][0]-e.anchors[1][0])/4*(_._dom.clientWidth/_._dom.clientHeight))]}]]}}})),graphic:L.shapeList[L.selected]?u.util.map(L.shapeList[L.selected].anchors,(function(e,r){return{type:"circle",position:_.convertToPixel("grid",[e[0],100-e[1]]),shape:{cx:0,cy:0,r:14},invisible:!0,draggable:!0,ondrag:u.util.curry((function(e){var r=_.convertFromPixel("grid",this.position);O({type:"MOVE_ANCHOR",location:[r[0],100-r[1]],anchorOrdinal:e})}),r),z:100}})):null}),!0),h(L)}),[L]);var A=n(null),_=A[0],S=A[1];r((function(){_&&(O({type:"LOAD",newShapeList:m,shapeOrdinal:p}),l&&l({createShape:k,deleteShape:T}))}),[_]);var H=i((function(e,r){O({type:e,location:r})})),k=function(e){O({type:"CREATE_SHAPE",shapeType:e.shapeType,color:e.color,data:e.data})},T=function(e){O({type:"DELETE_SHAPE",shapeOrdinal:e})};return e.createElement("div",{style:{height:"100%",width:"100%"},onClick:s(H("PUSH_ANCHOR"),v),onMouseMove:s(H("MOVE_LAST_ANCHOR"),v),onDoubleClick:s(H("OVER"),v),"data-testid":"MarkTool"},e.createElement(o,{onChartReady:S,option:g,style:{height:"100%",width:"100%"}}))}
