import e,{useEffect as r,useReducer as t,useState as n}from"react";import o from"echarts-for-react";import{update as a,last as i,head as s,equals as c,slice as h,remove as l,curry as p,compose as u}from"ramda";import d from"echarts";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var f=function(){return(f=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function y(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;var n=Array(e),o=0;for(r=0;r<t;r++)for(var a=arguments[r],i=0,s=a.length;i<s;i++,o++)n[o]=a[i];return n}var v={grid:{top:0,right:1,bottom:1,left:0},xAxis:{min:0,max:1,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},yAxis:{min:0,max:1,inverse:!0,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},series:[]},g=function(e){var r=e.nativeEvent.offsetX||0,t=e.nativeEvent.offsetY||0;return[r/(e.currentTarget.clientWidth||0)||0,t/(e.currentTarget.clientHeight||0)||0]},E=function(e,r){var t,n;return.05-(t=e,n=r,Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)))<0?r:e},m=function(e){return c(s(e),i(e))},L=function(e){return a(-1,E(s(e),i(e)),e)},O=function(e){return{anchors:[],color:e.color,over:!1,type:e.shapeType,data:e.data}},b=function(e,r){var t=e[0],n=t[0],o=t[1],a=e[1],i=a[0],s=a[1];return[[(n+i)/2-(o-s)/4/r,(o+s)/2+(n-i)/4*r],[(n+i)/2+(o-s)/4/r,(o+s)/2-(n-i)/4*r]]};function A(e,r){var t=r.type,n=r.location,o=r.newShapeList,i=r.shapeOrdinal,c=r.shapeType,p=r.anchorOrdinal,u=r.color,d=r.data,v=e.shapeList,g=e.selected,E=v[g];switch(t){case"CREATE_SHAPE":e={shapeList:y(v,[O({shapeType:c||"line",color:u,data:d})]),selected:v.length};break;case"DELETE_SHAPE":if(void 0===i)break;e={shapeList:l(i,1,v),selected:0};break;case"CHANGE_SELECTED":if(void 0===i)break;e=f(f({},e),{selected:i});break;case"PUSH_ANCHOR":if(!E||E.over||!n)break;if(E.anchors.length<1&&E.anchors.push(n),"polygon"===E.type&&E.anchors.length>3&&(E.anchors=L(E.anchors),E.over=m(E.anchors),E.over)){e=f({},e);break}if("sides"===E.type&&E.anchors.length>1){E.over=!0,e=f({},e);break}E.anchors.push(n),e=f({},e);break;case"MOVE_LAST_ANCHOR":E&&!E.over&&E.anchors.length>0&&(E.anchors=a(-1,n,E.anchors),e=f({},e));break;case"MOVE_ANCHOR":E&&E.anchors.length>0&&"number"==typeof p&&(E.anchors=a(p,n,E.anchors),"polygon"===E.type&&E.over&&r.anchorOrdinal===E.anchors.length-1&&(E.anchors=a(0,n,E.anchors)),e=f({},e));break;case"OVER":if(E&&!E.over&&E.anchors.length>0){if(E.anchors=h(0,-2,E.anchors),"polygon"===E.type&&E.anchors.length>3&&(E.anchors=a(-1,s(E.anchors),E.anchors)),"polygon"===E.type&&E.anchors.length<=3)break;if("line"===E.type&&E.anchors.length<2)break;E.over=!0,e=f({},e)}break;case"LOAD":g=i,(!i||i<0||i>=o.length)&&(g=0),e={selected:g,shapeList:o}}return e}export default function(a){var i=a.onChange,s=a.onReady,h=a.selected,l=a.showGrid,y=void 0!==l&&l,E=a.value;r((function(){c(L.shapeList,E)||O({type:"LOAD",newShapeList:E})}),[E]),r((function(){O({type:"CHANGE_SELECTED",shapeOrdinal:h})}),[h]),v.xAxis.splitLine.show=y,v.yAxis.splitLine.show=y;var m=t(A,{selected:0,shapeList:E}),L=m[0],O=m[1];r((function(){if(k){var e=k._dom.clientWidth/k._dom.clientHeight,r=L.shapeList,t=L.selected,n=r[t];k.setOption(f(f({},v),{series:r.map((function(r,n){return{type:"line",symbolSize:n===t?14:0,data:r.anchors.map((function(e){return[e[0],e[1]]})),lineStyle:{color:r.color},itemStyle:{color:r.color},markLine:"sides"===r.type&&{symbol:["circle","triangle"],data:r.anchors[0]&&[[{coord:b(r.anchors,e)[0]},{coord:b(r.anchors,e)[1]}]]}}})),graphic:n?n.anchors.map((function(e,r){return{type:"circle",position:k.convertToPixel("grid",[e[0],e[1]]),shape:{cx:0,cy:0,r:14},invisible:!0,draggable:!0,ondrag:d.util.curry((function(e){var r=k.convertFromPixel("grid",this.position);O({type:"MOVE_ANCHOR",location:[r[0],r[1]],anchorOrdinal:e})}),r),z:100}})):null}),!0)}i(L)}),[L]);var S=n(null),k=S[0],T=S[1];r((function(){k&&(O({type:"LOAD",newShapeList:E,shapeOrdinal:h}),s&&s({createShape:H,deleteShape:_}))}),[k]);var C=p((function(e,r){O({type:e,location:r})})),H=function(e){O({type:"CREATE_SHAPE",shapeType:e.shapeType,color:e.color,data:e.data})},_=function(e){O({type:"DELETE_SHAPE",shapeOrdinal:e})};return e.createElement("div",{style:{height:"100%",width:"100%"},onClick:u(C("PUSH_ANCHOR"),g),onMouseMove:u(C("MOVE_LAST_ANCHOR"),g),onDoubleClick:u(C("OVER"),g),"data-testid":"MarkTool"},e.createElement(o,{onChartReady:T,option:v,style:{height:"100%",width:"100%"}}))}
