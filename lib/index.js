import e,{useState as t,useReducer as n,useEffect as o}from"react";import r from"echarts-for-react";import{equals as a,curry as i,compose as s,slice as c,update as h,head as l,last as p,remove as d}from"ramda";import u from"echarts";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var y=function(){return(y=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function f(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var o=Array(e),r=0;for(t=0;t<n;t++)for(var a=arguments[t],i=0,s=a.length;i<s;i++,r++)o[r]=a[i];return o}var g={grid:{top:0,right:1,bottom:1,left:0},xAxis:{min:0,max:100,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},yAxis:{min:0,max:100,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},series:[]},v=function(e){var t=e.nativeEvent.offsetX||0,n=e.nativeEvent.offsetY||0;return[100*t/(e.currentTarget.clientWidth||0)||0,100*n/(e.currentTarget.clientHeight||0)||0]},m=function(e,t){var n,o;return 5-(n=e,o=t,Math.sqrt(Math.pow(Math.abs(n[0]-o[0]),2)+Math.pow(Math.abs(n[1]-o[1]),2)))<0?t:e},E=function(e){return a(l(e),p(e))},L=function(e){return h(-1,m(l(e),p(e)),e)},b=function(e){return{anchors:[],color:e.color,over:!1,type:e.shapeType,data:e.data}};function O(e,t){var n=t.type,o=t.location,r=t.newShapeList,a=t.shapeOrdinal,i=t.shapeType,s=t.anchorOrdinal,p=t.color,u=t.data,g=e.shapeList,v=e.selected,m=g[v];switch(n){case"CREATE_SHAPE":e={shapeList:f(g,[b({shapeType:i||"line",color:p,data:u})]),selected:g.length};break;case"DELETE_SHAPE":if(void 0===a)break;e={shapeList:d(a,1,g),selected:0};break;case"CHANGE_SELECTED":if(void 0===a)break;e=y(y({},e),{selected:a});break;case"PUSH_ANCHOR":if(!m||m.over||!o)break;if(m.anchors.length<1&&m.anchors.push(o),"polygon"===m.type&&m.anchors.length>3&&(m.anchors=L(m.anchors),m.over=E(m.anchors),m.over)){e=y({},e);break}if("sides"===m.type&&m.anchors.length>1){m.over=!0,e=y({},e);break}m.anchors.push(o),e=y({},e);break;case"MOVE_LAST_ANCHOR":m&&!m.over&&m.anchors.length>0&&(m.anchors=h(-1,o,m.anchors),e=y({},e));break;case"MOVE_ANCHOR":m&&m.anchors.length>0&&"number"==typeof s&&(m.anchors=h(s,o,m.anchors),"polygon"===m.type&&m.over&&t.anchorOrdinal===m.anchors.length-1&&(m.anchors=h(0,o,m.anchors)),e=y({},e));break;case"OVER":if(m&&!m.over&&m.anchors.length>0){if(m.anchors=c(0,-2,m.anchors),"polygon"===m.type&&m.anchors.length>3&&(m.anchors=h(-1,l(m.anchors),m.anchors)),"polygon"===m.type&&m.anchors.length<=3)break;if("line"===m.type&&m.anchors.length<2)break;m.over=!0,e=y({},e)}break;case"LOAD":v=a,(!a||a<0||a>=r.length)&&(v=0),e={selected:v,shapeList:r}}return e}export default function(c){var h=t(null),l=h[0],p=h[1],d=n(O,{selected:0,shapeList:c.value}),f=d[0],m=d[1];g.xAxis.splitLine.show=Boolean(c.showGrid),g.yAxis.splitLine.show=Boolean(c.showGrid),o((function(){l&&l.setOption(y(y({},g),{series:f.shapeList.map((function(e,t){return{type:"line",symbolSize:t===f.selected?14:0,data:e.anchors.map((function(e){return[e[0],100-e[1]]})),lineStyle:{color:e.color},itemStyle:{color:e.color},markLine:"sides"===e.type&&{symbol:["circle","triangle"],data:e.anchors[0]&&[[{coord:[(e.anchors[0][0]+e.anchors[1][0])/2-(e.anchors[0][1]-e.anchors[1][1])/4*(l._dom.clientHeight/l._dom.clientWidth),100-((e.anchors[0][1]+e.anchors[1][1])/2+(e.anchors[0][0]-e.anchors[1][0])/4*(l._dom.clientWidth/l._dom.clientHeight))]},{coord:[(e.anchors[0][0]+e.anchors[1][0])/2+(e.anchors[0][1]-e.anchors[1][1])/4*(l._dom.clientHeight/l._dom.clientWidth),100-((e.anchors[0][1]+e.anchors[1][1])/2-(e.anchors[0][0]-e.anchors[1][0])/4*(l._dom.clientWidth/l._dom.clientHeight))]}]]}}})),graphic:f.shapeList[f.selected]?u.util.map(f.shapeList[f.selected].anchors,(function(e,t){return{type:"circle",position:l.convertToPixel("grid",[e[0],100-e[1]]),shape:{cx:0,cy:0,r:14},invisible:!0,draggable:!0,ondrag:u.util.curry((function(e){var t=l.convertFromPixel("grid",this.position);m({type:"MOVE_ANCHOR",location:[t[0],100-t[1]],anchorOrdinal:e})}),t),z:100}})):null}),!0),c.onChange(f)}),[f]),o((function(){m({type:"CHANGE_SELECTED",shapeOrdinal:c.selected})}),[c.selected]),o((function(){l&&(m({type:"LOAD",newShapeList:c.value,shapeOrdinal:c.selected}),c.onReady&&c.onReady({createShape:L,deleteShape:b}))}),[l]),o((function(){a(f.shapeList,c.value)||m({type:"LOAD",newShapeList:c.value})}),[c.value]);var E=i((function(e,t){m({type:e,location:t})})),L=function(e){m({type:"CREATE_SHAPE",shapeType:e.shapeType,color:e.color,data:e.data})},b=function(e){m({type:"DELETE_SHAPE",shapeOrdinal:e})};return e.createElement("div",{style:{height:"100%",width:"100%"},onClick:s(E("PUSH_ANCHOR"),v),onMouseMove:s(E("MOVE_LAST_ANCHOR"),v),onDoubleClick:s(E("OVER"),v),"data-testid":"MarkTool"},e.createElement(r,{onChartReady:p,option:g,style:{height:"100%",width:"100%"}}))}
