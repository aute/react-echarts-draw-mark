import e,{useState as t,useReducer as a,useEffect as n,useRef as o}from"react";import r from"echarts-for-react";import{equals as i,curry as l,compose as c,remove as d,update as s,last as p,head as h,slice as u}from"ramda";import f from"echarts";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var y=function(){return(y=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var o in t=arguments[a])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function E(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),o=0;for(t=0;t<a;t++)for(var r=arguments[t],i=0,l=r.length;i<l;i++,o++)n[o]=r[i];return n}var g={grid:{top:0,right:1,bottom:1,left:0},xAxis:{min:0,max:100,type:"value",axisLine:{lineStyle:{color:"#DEDEDE"},onZero:!1}},yAxis:{min:0,max:100,type:"value",axisLine:{lineStyle:{color:"#DEDEDE"},onZero:!1}},series:[]},v=function(e,t,a,n){return Math.sqrt(Math.pow(Math.abs(e-a),2)+Math.pow(Math.abs(t-n),2))},m=function(e){return[100*e.nativeEvent.offsetX/e.target.clientWidth,100-100*e.nativeEvent.offsetY/e.target.clientHeight]},b=function(e,t){return 5-v.apply(void 0,E(e,t))<0?t:e},k=function(e){return i(h(e),p(e))},L=function(e){return s(-1,b(h(e),p(e)),e)},O=function(e){return{data:[],color:e.color,over:!1,type:e.shapeType}};function C(e,t){var a=t.type,n=t.location,o=t.newShapeList,r=t.shapeOrdinal,i=t.shapeType,l=t.anchorOrdinal,c=t.color,p=e.shapeList,f=p[e.selected];switch(a){case"CREATE_SHAPE":e={shapeList:E(p,[O({shapeType:i||"line",color:c})]),selected:p.length};break;case"DELETE_SHAPE":if(void 0===r)break;e={shapeList:d(r,1,p),selected:0};break;case"CHANGE_SELECTED":if(void 0===r)break;e=y(y({},e),{selected:r});break;case"PUSH_ANCHOR":if(!f||f.over||!n)break;if(f.data.length<1&&f.data.push(n),"polygon"===f.type&&f.data.length>2&&(f.data=L(f.data),f.over=k(f.data),f.over&&(e=y({},e))),"sides"===f.type&&f.data.length>1){f.over=!0,e=y({},e);break}f.data.push(n),e=y({},e);break;case"MOVE_LAST_ANCHOR":f&&!f.over&&f.data.length>0&&(f.data=s(-1,n,f.data),e=y({},e));break;case"MOVE_ANCHOR":f&&f.data.length>0&&l&&(f.data=s(l,n,f.data),"polygon"===f.type&&f.over&&t.anchorOrdinal===f.data.length-1&&(f.data=s(0,n,f.data)),e=y({},e));break;case"OVER":if(f&&!f.over&&f.data.length>0){if(f.data=u(0,-2,f.data),"polygon"===f.type&&f.data.length>3&&(f.data=s(-1,h(f.data),f.data)),"polygon"===f.type&&f.data.length<=3)break;if("line"===f.type&&f.data.length<2)break;f.over=!0,e=y({},e)}break;case"LOAD":e={selected:0,shapeList:o}}return e}var A=function(o){var d=t(null),s=d[0],p=d[1],h=a(C,{selected:0,shapeList:o.value}),u=h[0],E=h[1];n((function(){s&&s.setOption(y(y({},g),{series:u.shapeList.map((function(e,t){return{type:"line",symbolSize:t===u.selected?14:0,data:e.data,lineStyle:{color:e.color},itemStyle:{color:e.color},markLine:"sides"===e.type&&{symbol:["circle","triangle"],data:e.data[0]&&[[{coord:[(e.data[0][0]+e.data[1][0])/2-(e.data[0][1]-e.data[1][1])/4*(s._dom.clientHeight/s._dom.clientWidth),(e.data[0][1]+e.data[1][1])/2+(e.data[0][0]-e.data[1][0])/4*(s._dom.clientWidth/s._dom.clientHeight)]},{coord:[(e.data[0][0]+e.data[1][0])/2+(e.data[0][1]-e.data[1][1])/4*(s._dom.clientHeight/s._dom.clientWidth),(e.data[0][1]+e.data[1][1])/2-(e.data[0][0]-e.data[1][0])/4*(s._dom.clientWidth/s._dom.clientHeight)]}]]}}})),graphic:u.shapeList[u.selected]?f.util.map(u.shapeList[u.selected].data,(function(e,t){return{type:"circle",position:s.convertToPixel("grid",e),shape:{cx:0,cy:0,r:5},invisible:!0,draggable:!0,ondrag:f.util.curry((function(e){var t=s.convertFromPixel("grid",this.position);E({type:"MOVE_ANCHOR",location:t,anchorOrdinal:e})}),t),z:100}})):null}),!0),o.onChange(u)}),[u]),n((function(){E({type:"CHANGE_SELECTED",shapeOrdinal:o.selected})}),[o.selected]),n((function(){o.onReady({createShape:b,deleteShape:k}),E({type:"LOAD",newShapeList:o.value})}),[s]),n((function(){i(u.shapeList,o.value)||E({type:"LOAD",newShapeList:o.value})}),[o.value]);var v=l((function(e,t){E({type:e,location:t})})),b=function(e,t){E({type:"CREATE_SHAPE",shapeType:e,color:t})},k=function(e){E({type:"DELETE_SHAPE",shapeOrdinal:e})};return e.createElement("div",{style:{height:"100%",width:"100%"},onClick:c(v("PUSH_ANCHOR"),m),onMouseMove:c(v("MOVE_LAST_ANCHOR"),m),onDoubleClick:c(v("OVER"),m)},e.createElement(r,{onChartReady:function(e){p(e)},option:g,style:{height:"100%",width:"100%"}}))},S=function(){var a=o(null),n=t([]),r=n[0],i=n[1],l=t(0),c=l[0],d=l[1],s=function(e,t){a.current.createShape(e,t)};return e.createElement("div",{style:{width:"100%",marginTop:"100px"}},e.createElement("div",{style:{width:"60%",height:"400px",display:"inline-block"}},e.createElement(A,{onReady:function(e){a.current=e},onChange:function(e){i(e.shapeList),d(e.selected)},value:r,selected:c}),e.createElement("button",{onClick:function(){return s("line","#fff000")}},"添加线"),e.createElement("button",{onClick:function(){return s("polygon")}},"添加多边形"),e.createElement("button",{onClick:function(){return s("sides","#fff000")}},"添加指向划分"),e.createElement("button",{onClick:function(){return i(E(r,[{data:[[40.476190476190474,27],[42.65862837093471,45.47869842452812],[84.34510065285191,79.31265771239623],[67.47115285773026,28.76691698729245],[40.476190476190474,27]],over:!0,type:"polygon"}]))}},"添加完整多边形")),r&&r.map((function(t,n){return e.createElement("div",{key:n,onClick:function(){d(n)},style:{padding:"0.5rem",border:"1px solid #ddd",backgroundColor:c===n?"#ddd":"#f0f2f5"}},e.createElement("p",null,n,e.createElement("span",{onClick:function(e){var t;e.stopPropagation(),t=n,a.current.deleteShape(t)}}," Delete")))})))};export{S as Line};
