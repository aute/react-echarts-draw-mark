import e,{useReducer as r,useEffect as t,useState as n}from"react";import a from"echarts-for-react";import{update as o,last as i,head as s,equals as c,slice as l,remove as h,max as p,curry as d,compose as y}from"ramda";import u from"echarts";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var f=function(){return(f=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)};function v(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;var n=Array(e),a=0;for(r=0;r<t;r++)for(var o=arguments[r],i=0,s=o.length;i<s;i++,a++)n[a]=o[i];return n}var g={grid:{top:0,right:1,bottom:1,left:0},xAxis:{min:0,max:1,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},yAxis:{min:0,max:1,inverse:!0,type:"value",splitLine:{show:!1},axisLine:{lineStyle:{color:"rgba(0,0,0,0)"},onZero:!1}},series:[]},m=function(e){var r=e.nativeEvent.offsetX||0,t=e.nativeEvent.offsetY||0;return[r/(e.currentTarget.clientWidth||0)||0,t/(e.currentTarget.clientHeight||0)||0]},E=function(e,r){var t,n;return.05-(t=e,n=r,Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)))<0?r:e},b=function(e){return c(s(e),i(e))},L=function(e){return o(-1,E(s(e),i(e)),e)},O=function(e){return{anchors:[],color:e.color,over:!1,type:e.shapeType,data:e.data}};function A(e,r){var t=r.type,n=r.location,a=r.newShapeList,i=r.shapeOrdinal,c=r.shapeType,p=r.anchorOrdinal,d=r.color,y=r.data,u=e.shapeList,g=u[e.selected];switch(t){case"CREATE_SHAPE":e={shapeList:v(u,[O({shapeType:c||"line",color:d,data:y})]),selected:u.length};break;case"DELETE_SHAPE":if(void 0===i)break;e={shapeList:h(i,1,u),selected:0};break;case"CHANGE_SELECTED":if(void 0===i)break;e=f(f({},e),{selected:i});break;case"PUSH_ANCHOR":if(!g||g.over||!n)break;if(g.anchors.length<1&&g.anchors.push(n),"polygon"===g.type&&g.anchors.length>3&&(g.anchors=L(g.anchors),g.over=b(g.anchors),g.over)){e=f({},e);break}if("sides"===g.type&&g.anchors.length>1){g.over=!0,e=f({},e);break}if("arrow"===g.type&&g.anchors.length>1){g.over=!0,e=f({},e);break}g.anchors.push(n),e=f({},e);break;case"MOVE_LAST_ANCHOR":g&&!g.over&&g.anchors.length>0&&(g.anchors=o(-1,n,g.anchors),e=f({},e));break;case"MOVE_ANCHOR":g&&g.anchors.length>0&&"number"==typeof p&&(g.anchors=o(p,n,g.anchors),"polygon"===g.type&&g.over&&r.anchorOrdinal===g.anchors.length-1&&(g.anchors=o(0,n,g.anchors)),e=f({},e));break;case"OVER":if(g&&!g.over&&g.anchors.length>0){if(g.anchors=l(0,-2,g.anchors),"polygon"===g.type&&g.anchors.length>3&&(g.anchors=o(-1,s(g.anchors),g.anchors)),"polygon"===g.type&&g.anchors.length<=3)break;if("line"===g.type&&g.anchors.length<2)break;g.over=!0,e=f({},e)}break;case"LOAD":e={selected:!i||i<0||i>=a.length?0:i,shapeList:a}}return e}export default function(o){var i=o.onChange,s=o.onReady,l=o.selected,h=o.showGrid,v=void 0!==h&&h,E=o.value,b=o.lineWidth,L=void 0===b?2:b,O=r(A,{selected:0,shapeList:E}),S=O[0],k=O[1];t((function(){c(S.shapeList,E)||k({type:"LOAD",newShapeList:E})}),[E]),t((function(){k({type:"CHANGE_SELECTED",shapeOrdinal:l})}),[l]),g.xAxis.splitLine.show=v,g.yAxis.splitLine.show=v;var w=n(null),C=w[0],H=w[1];t((function(){if(C){var e=C._dom.clientWidth/C._dom.clientHeight,r=S.shapeList,t=S.selected,n=r[t];C.setOption(f(f({},g),{series:r.map((function(r,n){var a,o,i=r.anchors[0]&&r.anchors[1]?r.anchors:[[0,0],[0,0]],s=i[0],c=s[0],l=s[1],h=i[1],d=h[0],y=h[1];return{type:"line",symbolSize:n===t?12:0,data:r.anchors,lineStyle:{color:r.color,width:L},itemStyle:{color:r.color},markPoint:"arrow"===r.type&&{silent:!0,symbol:"triangle",symbolSize:p(24,2.4*L*2),symbolRotate:d-c>0?180*Math.atan((-y+l)/(d-c)/e)/Math.PI-90:180*Math.atan((y-l)/(-d+c)/e)/Math.PI+90,data:(o=r.anchors[0]?function(e){var r=e[0],t=r[0],n=r[1],a=e[1];return[a[0]-t+t,a[1]-n+n]}(r.anchors):null,o?[{coord:o}]:null),animation:!1},markLine:"sides"===r.type&&{silent:!0,symbol:["circle","triangle"],symbolSize:p(12,2.4*L),lineStyle:{type:"solid",width:L},data:(a=r.anchors[0]?function(e,r){var t=e[0],n=t[0],a=t[1],o=e[1],i=o[0],s=o[1];return[[(n+i)/2-(a-s)/4/r,(a+s)/2+(n-i)/4*r],[(n+i)/2+(a-s)/4/r,(a+s)/2-(n-i)/4*r]]}(r.anchors,e):null,a?[[{coord:a[0]},{coord:a[1]}]]:null),animation:!1},clip:!1}})),graphic:n?n.anchors.map((function(e,r){return{type:"circle",position:C.convertToPixel("grid",[e[0],e[1]]),shape:{cx:0,cy:0,r:12},invisible:!0,draggable:!0,ondrag:u.util.curry((function(e){var r=C.convertFromPixel("grid",this.position);k({type:"MOVE_ANCHOR",location:[r[0],r[1]],anchorOrdinal:e})}),r),z:100}})):null}),!0),i&&i(S)}}),[S]);var T=function(e){k({type:"CREATE_SHAPE",shapeType:e.shapeType,color:e.color,data:e.data})},_=function(e){k({type:"DELETE_SHAPE",shapeOrdinal:e})};t((function(){C&&(k({type:"LOAD",newShapeList:E,shapeOrdinal:l}),s&&s({createShape:T,deleteShape:_}))}),[C]);var x=d((function(e,r){k({type:e,location:r})}));return e.createElement("div",{style:{height:"100%",width:"100%"},onClick:y(x("PUSH_ANCHOR"),m),onMouseMove:y(x("MOVE_LAST_ANCHOR"),m),onDoubleClick:y(x("OVER"),m),"data-testid":"MarkBoard"},e.createElement(a,{onChartReady:H,option:g,style:{height:"100%",width:"100%"}}))}
